rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{uid} {
      allow read: if request.auth != null && (request.auth.uid == uid || isAdminLike());
      allow create: if request.auth != null && request.auth.uid == uid;
      allow update: if request.auth != null && (request.auth.uid == uid || isAdminLike());
    }
    match /roles_matrix/{role} { allow read: if request.auth != null; allow write: if isSuperAdmin(); }
    match /user_overrides/{uid} { allow read: if request.auth != null && (request.auth.uid == uid || isSuperAdmin()); allow write: if isSuperAdmin(); }
    match /audit_logs/{doc} { allow read, write: if isSuperAdmin(); }

    // Counters (codigos automaticos)
    match /counters/{name} { allow read, write: if isAdminLike(); }

    // Colecciones
    match /zones/{id} { allow read: if request.auth != null; allow create, update: if isAdminLike(); }
    match /dependencies/{id} { allow read: if request.auth != null; allow create, update: if isAdminLike(); }
    match /sedes/{id} { allow read: if request.auth != null; allow create, update: if isAdminLike(); }
    match /employees/{id} { allow read: if request.auth != null; allow create, update: if isAdminLike(); }
    match /supernumerarios/{id} { allow read: if request.auth != null; allow create, update: if isAdminLike(); }
    match /supervisors/{id} { allow read: if request.auth != null; allow create, update: if isAdminLike(); }
    match /cargos/{id} { allow read: if request.auth != null; allow create, update: if isAdminLike(); }
    match /novedades/{id} { allow read: if request.auth != null; allow create, update: if isAdminLike(); }
    match /import_history/{id} { allow read: if request.auth != null; allow create, update: if isAdminLike(); }
    match /attendance/{id} { allow read: if request.auth != null; allow create, update: if isAdminLike(); }
    match /absenteeism/{id} { allow read: if request.auth != null; allow create, update: if isAdminLike(); }
    match /sede_status/{id} { allow read: if request.auth != null; allow create, update: if isAdminLike(); }
    match /import_replacements/{id} { allow read: if request.auth != null; allow create, update: if isAdminLike(); }
    match /whatsapp_incoming/{id} { allow read: if request.auth != null; allow write: if false; }
    match /daily_closures/{id} { allow read: if request.auth != null; allow create, update: if isAdminLike(); }
    match /daily_closure_snapshots/{id} { allow read: if request.auth != null; allow create, update: if isAdminLike(); }
    match /daily_closure_snapshots/{id}/{sub=**} { allow read: if request.auth != null; allow create, update: if isAdminLike(); }

    function isAdminLike(){
      return request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['superadmin','admin']
      );
    }
    function isSuperAdmin(){
      return request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin'
      );
    }
  }
}
